<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js discord">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Jumia Design</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="theme.css">
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "discord" : "discord";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('discord')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="overview.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Concepts</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="concepts/actions.html"><strong aria-hidden="true">2.1.</strong> Actions</a></li><li class="chapter-item expanded "><a href="concepts/builders.html"><strong aria-hidden="true">2.2.</strong> Builders</a></li><li class="chapter-item expanded "><a href="concepts/commands.html"><strong aria-hidden="true">2.3.</strong> Commands</a></li><li class="chapter-item expanded "><a href="concepts/storage.html"><strong aria-hidden="true">2.4.</strong> Storage</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jumia Design</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="overview"><a class="header" href="#overview">Overview</a></h1>
<p>Jumia is a Discord library for Rust built around a builder model that attempts to provide medium-sized bots with a very
easy framework to develop without making too much infrastructure.</p>
<p>Jumia will be a wrapper around another library to prevent fragmentation - but it will hopefully be an easy experience.</p>
<h3 id="alternatives"><a class="header" href="#alternatives">Alternatives</a></h3>
<p>I've looked at Poise, and I'm personally not much of a fan of the design ideas.</p>
<p>You could also just use base Serenity, but there is a lot of infrastructure that you have to build up before you can get
to actually implementing stuff. We hope to provide this built in.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="actions"><a class="header" href="#actions">Actions</a></h1>
<p>Actions are how you do things in Jumia. They must implement the <code>Action</code> trait.</p>
<h3 id="trait"><a class="header" href="#trait">Trait</a></h3>
<pre><pre class="playground"><code class="language-rust edition2021">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>trait Action {
    type Output;

    // Does the actual change without checking if it can
    async fn execute(self, client: &amp;Client) -&gt; Result&lt;Self::Output, Error&gt;;
    
    // Check if the action can be carried out. This may not be valid in the
    // future, since we can't stop Discord from doing stuff while we process
    async fn check(self, client: &amp;Client) -&gt; Result&lt;Self, Error&gt; { Ok(self) }
    
    // Check and then execute the action. This is the recommended way of running actions
    async fn run(self, client: &amp;Client) -&gt; Result&lt;Self::Output, Error&gt; {
        self.check(client).await?.execute(client).await
    }
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="example"><a class="header" href="#example">Example</a></h3>
<pre><pre class="playground"><code class="language-rust edition2021">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn example(ctx: &amp;Context) {
    let _new_channel = CreateGuildChannel::category()
        .name(&quot;Category Channel&quot;)
        .create_channel(CreateGuildChannel::text().name(&quot;text-channel&quot;))
        .run(ctx)
        .await
        .unwrap();
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="notes"><a class="header" href="#notes">Notes</a></h3>
<ul>
<li>Nested executions should be run in parallel when possible</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="builders"><a class="header" href="#builders">Builders</a></h1>
<p>Most things in Jumia are created using builders. This is especially the case for actions.</p>
<h3 id="conversion"><a class="header" href="#conversion">Conversion</a></h3>
<p>In order to keep the builders ergonomic, many converter traits are utilized. For example, these are all valid usages of
the <code>CreateOverwrite</code> builder, through the <code>Into&lt;RoleId&gt;</code> trait.</p>
<pre><pre class="playground"><code class="language-rust edition2021">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn example(some_role: Role, an_id: RoleId) {
    CreateOverwrite::builder()
        .role(some_role)
        .allow(Permissions::VIEW_CHANNEL);

    CreateOverwrite::builder()
        .role(an_id)
        .allow(Permissions::VIEW_CHANNEL);

    CreateOverwrite::builder()
        .role(123)
        .allow(Permissions::VIEW_CHANNEL);
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="todo"><a class="header" href="#todo">Todo</a></h3>
<ul>
<li>Look into how rustc optimizes builders</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="commands"><a class="header" href="#commands">Commands</a></h1>
<p>This is an example of an implementation of a command</p>
<pre><pre class="playground"><code class="language-rust edition2021">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// library code
trait CommandCallback {
    type Error: Into&lt;JumiaError&gt;;
    
    async fn call(&amp;self, ctx: &amp;Context, interaction: &amp;Interaction, args: &amp;CommandArgs) -&gt; Result&lt;(), E&gt;;
}

impl&lt;E, F, G&gt; CommandCallback&lt;E&gt; for F
where 
    E: Into&lt;JumiaError&gt;,
    F: Fn(&amp;Client, &amp;Interaction, &amp;CommandArgs) -&gt; G,
    G: Future&lt;Output = Result&lt;(), E&gt;&gt;,
{
    type Error = E;
    
    async fn call(&amp;self, ctx: &amp;Context, interaction: &amp;Interaction, args: &amp;CommandArgs) -&gt; Result&lt;(), E&gt; {
        self(ctx, interaction, args)
    }
}

// either library or user code
trait GuildOnly&lt;F: CommandCallback&gt; {
    fn guild_only(callback: impl CommandCallback) -&gt; F;
}

impl&lt;E: Into&lt;JumiaError&gt;, C: CommandCallback&lt;E&gt;, F: CommandCallback&gt; GuildOnly&lt;F&gt; for C
{
    fn guild_only(self) -&gt; F {
        |ctx, interaction, args| async move {
            if interaction.guild_id.is_none() {
                interaction.reply(ctx, &quot;Command must be run in guild&quot;).await?;
            } else {
                callback(ctx, interaction, args).await?;
            }
        }
    }
}

// user code
async fn echo_command(ctx: Context, interaction: Interaction, args: CommandArgs) -&gt; Result&lt;(), BotError&gt; {
    interaction.reply(ctx, args.get_string(&quot;text&quot;)).await?;
    Ok(())
}

fn example() {
    Client::builder()
        .command(
            // there could probably be a better way of formatting this, but for now it's good enough
            CommandBuilder::new()
                .name(&quot;echo&quot;)
                .option(OptionBuilder::new()
                    .name(&quot;text&quot;)
                    .kind(OptionKind::String))
                .callback(echo_command.guild_only())
        );
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="notes-1"><a class="header" href="#notes-1">Notes</a></h3>
<ul>
<li>Decl macro style definitions don't really fit into the style of Jumia</li>
<li>Derive macros are a future goal</li>
<li>Pure router style isn't very good</li>
<li>Custom permission system using storage</li>
<li>Arg parsing using system similar to serenity-slash-decode</li>
<li>Vicky suggested an alternative way of doing this:
<a href="https://discord.com/channels/381880193251409931/381880193700069377/940070735349698600">d/serenity-rs Message Link</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="storage"><a class="header" href="#storage">Storage</a></h1>
<p>Jumia has a persistence system that allows pre-built systems to use persistent data without significant user
configuration. An example of this can be found
<a href="https://github.com/squili/jumia-design/blob/main/examples/storage/src/main.rs">in the examples</a>.</p>
<h3 id="traits"><a class="header" href="#traits">Traits</a></h3>
<p>There are two traits that the storage system uses. The storage backend must implement the <code>StorageBackend</code> trait. A
storage key must implement the <code>StorageKey</code> trait.</p>
<pre><pre class="playground"><code class="language-rust edition2021">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>trait StorageKey {
    const ID: &amp;'static str;
    type Value: DeserializeOwned + Serialize + Send;

    fn get_key(self) -&gt; String;
}

trait StorageBackend: Sized {
    type Error: std::error::Error;

    async fn register&lt;K: StorageKey + Send&gt;(&amp;self) -&gt; Result&lt;(), Self::Error&gt;;
    async fn get&lt;K: StorageKey + Send&gt;(&amp;self, key: K) -&gt; Result&lt;Option&lt;K::Value&gt;, Self::Error&gt;;
    async fn set&lt;K: StorageKey + Send&gt;(&amp;self, key: K, value: K::Value) -&gt; Result&lt;(), Self::Error&gt;;
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="provided"><a class="header" href="#provided">Provided</a></h3>
<p>A user implementing this system, especially for a more complex backend, could take an evening. Instead, Jumia will
provide some default implementations - file and redis (and maybe etcd)</p>
<h3 id="extensible"><a class="header" href="#extensible">Extensible</a></h3>
<p>This extensible system means that anyone can write an addon system that will use a centralized persistent data system.
For example, a custom permission system could just need a <code>Permission</code> struct supplied with a storage backend and
provide a wrapper function. For the library user, this is very simple and easy. Another example is resumable sessions.
Currently, no library automatically supports resumable sessions, but it'd be really cool to automatically load those.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="theme.js"></script>
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
